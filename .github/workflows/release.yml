name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test -race -v ./...

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          COMMIT="${GITHUB_SHA::7}"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          go build -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}" \
            -o open-entire ./cmd/entire

      - name: Package
        run: |
          ARCHIVE="open-entire_${GITHUB_REF_NAME#v}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz"
          tar czf "${ARCHIVE}" open-entire
          sha256sum "${ARCHIVE}" > "${ARCHIVE}.sha256"
          echo "ARCHIVE=${ARCHIVE}" >> "$GITHUB_ENV"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ARCHIVE }}
            ${{ env.ARCHIVE }}.sha256

  checksums:
    name: Checksums
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Download all release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p assets
          for combo in linux_amd64 linux_arm64 darwin_amd64 darwin_arm64; do
            gh release download "${GITHUB_REF_NAME}" \
              --repo "${{ github.repository }}" \
              --pattern "open-entire_${VERSION}_${combo}.tar.gz.sha256" \
              --dir assets || true
          done

      - name: Aggregate checksums
        run: |
          cat assets/*.sha256 > checksums.txt

      - name: Upload combined checksums
        uses: softprops/action-gh-release@v2
        with:
          files: checksums.txt
